<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Attendance Application</title>
    <link rel="stylesheet" href="/static/app.css">

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script>
        (function () {
            emailjs.init("2dbEEsipNp7REQJzt");
        })();
    </script>
</head>

<body>
    <div class="container">
        <h2>Event Attendance Application</h2>
        <form id="attendanceForm">
            <div class="detatil">
                <label>Your Name:</label>
                <input type="text" id="senderName" required>

                <label>Event Name:</label>
                <input type="text" id="eventName" required>

                <label>Venue/Institution Name:</label>
                <input type="text" id="eventLocation" required>

                <label>Start Date:</label>
                <input type="date" id="startDate" required>

                <label>End Date:</label>
                <input type="date" id="endDate" required>

                <label>Receiver Email (optional):</label>
                <input type="email" id="toEmail" placeholder="Enter teacher email">
                
                <!-- ‚úÖ NEW OPTION -->
                <label style="margin-top:8px;">
                    <input type="checkbox" id="sendEmailOption">
                    Send email notification
                </label>
            </div>

            <div class="student-list">
                <label>Select Students:</label>
                <label><input type="checkbox" class="student" value="Aryan Thawkar (UID: 23011023)"> Aryan Thawkar</label>
                <label><input type="checkbox" class="student" value="Nishant Gakare (UID: 23011032)"> Nishant Gakare</label>
                <label><input type="checkbox" class="student" value="Ishan Pote (UID: 23011002)"> Ishan Pote</label>
                <label><input type="checkbox" class="student" value="Ajinkya Mariche (UID: 23011026)"> Ajinkya Mariche</label>
                <label><input type="checkbox" class="student" value="Shrenik Nil (UID: 23011033)"> Shrenik Nil</label>
            </div>

            <button type="button" onclick="generateApplication()">Generate Application</button>
            <button type="button" id="downloadBtn" style="display:none;" onclick="downloadApplication()">Download as Word</button>
        </form>

        <div id="application" style="display:none; margin-top:20px;">
            <div class="application-container">
                <p id="appContent"></p>
            </div>
        </div>
    </div>

<script>
function sendEmail(data) {
    emailjs.send("service_rqrt9n5", "template_q7qffj9", {
        sender_name: data.senderName,
        event_name: data.eventName,
        event_location: data.eventLocation,
        start_date: data.startDate,
        end_date: data.endDate,
        to_email: data.toEmail
    }).then(
        function () {
            alert("üìß Email sent successfully!");
        },
        function (error) {
            console.log("Email failed...", error);
            alert("‚ùå Email failed to send");
        }
    );
}

function generateApplication() {
    let senderName = document.getElementById("senderName").value.trim();
    let eventName = document.getElementById("eventName").value.trim();
    let eventLocation = document.getElementById("eventLocation").value.trim();
    let startDate = document.getElementById("startDate").value;
    let endDate = document.getElementById("endDate").value;
    let toEmail = document.getElementById("toEmail").value.trim();
    let sendEmailChecked = document.getElementById("sendEmailOption").checked;

    let selectedStudents = [];
    document.querySelectorAll(".student:checked").forEach(student => {
        selectedStudents.push(student.value);
    });

    if (!senderName || !eventName || !eventLocation || !startDate || !endDate || selectedStudents.length === 0) {
        alert("‚ö†Ô∏è Please fill all required fields.");
        return;
    }

    if (sendEmailChecked && !toEmail) {
        alert("‚ö†Ô∏è Please enter receiver email to send mail.");
        return;
    }

    let applicationText = `
        To<br>
        Class Counsellor<br>
        CSE Data Science<br><br>
        <strong>Subject:</strong> Request for Attendance Grant ‚Äì ${eventName} Participation<br><br>
        Respected Sir/Madam,<br><br>
        I, <strong>${senderName}</strong>, am participating in <strong>${eventName}</strong> at <strong>${eventLocation}</strong> from <strong>${startDate}</strong> to <strong>${endDate}</strong>.<br><br>
        Participants:<br>${selectedStudents.join(", ")}<br><br>
        Kindly grant attendance.<br><br>
        Sincerely,<br><strong>${senderName}</strong>
    `;

    document.getElementById("appContent").innerHTML = applicationText;
    document.getElementById("application").style.display = "block";
    document.getElementById("downloadBtn").style.display = "block";

    // ‚úÖ Optional email
    if (sendEmailChecked) {
        sendEmail({ senderName, eventName, eventLocation, startDate, endDate, toEmail });
    }

    localStorage.setItem("eventData", JSON.stringify({
        senderName, eventName, eventLocation, startDate, endDate, students: selectedStudents
    }));
}

function downloadApplication() {
    let eventData = localStorage.getItem("eventData");

    fetch("/download", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: eventData
    })
    .then(response => response.blob())
    .then(blob => {
        let link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);
        link.download = "Event_Attendance_Application.docx";
        link.click();
    });
}
</script>

</body>
</html>
